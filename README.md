# **Bearer Proxy**

> **Назначение**  
> **Bearer Proxy** — это тонкий шлюз-аутентификатор между вашими пользователями и сторонним API.  
> • **Пользователям** вы выдаёте собственные краткоживущие токены, управляемые в вашей БД.  
> • **Прокси** проверяет каждый такой токен, ведёт счётчик использований и при успехе - подменяет его на **единый сервис-токен** удалённого провайдера.  
> Внешний API «видит» только один доверенный ключ, а ротация и блокировка пользовательских ключей происходят без участия провайдера — достаточно обновить записи в таблице `tokens`.
---

## 1. Предварительные требования

| Компонент          | Версия                                          | Ссылка                                    |
|--------------------|-------------------------------------------------|-------------------------------------------|
| **Docker Engine**  | 20.10 +                                         | <https://docs.docker.com/engine/install/> |
| **Docker Compose** | v2 (входит в Docker Desktop / Docker для Linux) | <https://docs.docker.com/compose/>        |

> ✅ Поддерживаются Windows 10/11, macOS (Apple Silicon и x86-64) и любые современные дистрибутивы Linux.

---

## 2. Подготовка DNS

1. Создайте **A-запись** для домена, на котором будет работать прокси.  
   Пример:
   ```
   api.your-server.local  →  203.0.113.10   # публичный IP вашего хоста
   ```
2. Убедитесь, что порт **443** (и, при необходимости, 80) проброшены наружу.

---

## 3. Настройка окружения

1. Склонируйте репозиторий:
   ```bash
   git clone https://github.com/Tatikoma/bearer-proxy.git
   cd bearer-proxy
   ```
2. Скопируйте файл примера и отредактируйте переменные:
   ```bash
   cp .env.example .env
   ```

| Переменная          | Описание                                        | Пример                                           |
|---------------------|-------------------------------------------------|--------------------------------------------------|
| `LISTEN_HOST`       | Домен, на котором будет слушать Caddy           | `api.your-server.local`                          |
| `TARGET_HOST`       | Хост удалённого API                             | `api.remote-provider.local`                      |
| `UPSTREAM_TOKEN`    | **Единый** токен, который отправляется апстриму | `here-is-your-token-on-remote-provider-upstream` |
| `POSTGRES_DB`       | Название БД                                     | `app`                                            |
| `POSTGRES_USER`     | Пользователь Postgres                           | `postgres`                                       |
| `POSTGRES_PASSWORD` | Пароль                                          | `strong-password`                                |

---

## 4. Запуск

```bash
docker compose up -d          # сборка образов и запуск всех сервисов
```

Сервисы:

| Сервис    | Порт     | Назначение                                       |
|-----------|----------|--------------------------------------------------|
| **proxy** | 8080     | Go-приложение Reverse Proxy                      |
| **caddy** | 80 / 443 | HTTPS-терминирование, автоматические сертификаты |
| **db**    | 5432     | Postgres для хранения токенов                    |

---

## 5. Управление токенами пользователей

1. Подключитесь к Postgres внутри контейнера:
   ```bash
   docker compose exec db psql -U postgres app
   ```
2. Посмотрите список токенов:
   ```sql
   SELECT * FROM tokens;
   ```
3. Добавьте новый пользовательский токен:
   ```sql
   INSERT INTO tokens (token) VALUES ('example-user-token');
   ```
   > Таблица `tokens` содержит также счётчик использований и дату создания — их можно использовать для аналитики.

---

## 6. Проверка работы

```bash
curl -H "Authorization: Bearer example-user-token" https://api.your-server.local/v1/health
```

1. Прокси сверит токен `example-user-token` в базе.
2. Заменит его на `UPSTREAM_TOKEN`.
3. Перешлёт запрос на `https://api.remote-provider.local/v1/health`.
4. Ответ апстрима прозрачно вернётся пользователю.

---

## 7. Часто задаваемые вопросы

| Вопрос                                       | Ответ                                                                                                                       |
|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| **Как сгенерировать 100+ токенов сразу?**    | Выполните в psql:  <br>`INSERT INTO tokens(token) SELECT encode(gen_random_bytes(24), 'hex') FROM generate_series(1, 100);` |
| **Можно ли горячо менять `UPSTREAM_TOKEN`?** | Да. Достаточно обновить переменную в `.env` и перезапустить службу: <br>`docker compose up -d app`                          |
| **Логи прокси?**                             | `docker compose logs -f app`                                                                                                |
| **Ротация сертификатов Caddy?**              | Выполняется автоматически через Let’s Encrypt; хранится в volume `caddy_data`.                                              |

---

## 8. Обновление

```bash
git pull
docker compose pull           # новые базовые образы
docker compose build --pull   # пересобрать приложение
docker compose up -d          # плавный рестарт
```